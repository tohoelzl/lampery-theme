{% comment %}
  Main Collection Section - High-End Design
  Features: Filter sidebar/drawer, sorting, product grid, pagination
{% endcomment %}

{%- liquid
  assign products_per_page = section.settings.products_per_page
  assign columns = section.settings.columns_desktop
  assign filter_type = section.settings.filter_type
  assign card_size = section.settings.card_size | default: 'medium'
  assign card_gap = section.settings.card_gap | default: 24
-%}

<section class="main-collection bg-background" x-data="{ filterOpen: false }">
  <div class="main-collection__wrapper container mx-auto px-4 lg:px-8">

    <div class="main-collection__layout">

      {% comment %} ========== FILTER SIDEBAR (Desktop) ========== {% endcomment %}
      {% if section.settings.enable_filtering and filter_type == 'sidebar' %}
        <aside class="main-collection__sidebar hidden lg:block">
          <div class="main-collection__sidebar-inner">
            <form id="CollectionFiltersFormSidebar" action="{{ collection.url }}" method="get">
              {% render 'collection-filters', collection: collection %}
            </form>
          </div>
        </aside>
      {% endif %}

      {% comment %} ========== MAIN CONTENT ========== {% endcomment %}
      <div class="main-collection__content">

        {% comment %} Toolbar {% endcomment %}
        <div class="collection-toolbar">
          <div class="collection-toolbar__left">
            {% comment %} Filter Toggle (Mobile or Drawer mode) {% endcomment %}
            {% if section.settings.enable_filtering %}
              <button
                type="button"
                class="collection-toolbar__filter-btn{% if filter_type == 'sidebar' %} lg:hidden{% endif %}"
                @click="filterOpen = true"
              >
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                  <path d="M5 10H15M2.5 5H17.5M7.5 15H12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>{{ 'collections.filtering.filter' | t | default: 'Filter' }}</span>
                {% if collection.filters.size > 0 %}
                  {%- assign active_filters_count = 0 -%}
                  {%- for filter in collection.filters -%}
                    {%- assign active_filters_count = active_filters_count | plus: filter.active_values.size -%}
                  {%- endfor -%}
                  {% if active_filters_count > 0 %}
                    <span class="collection-toolbar__filter-count">{{ active_filters_count }}</span>
                  {% endif %}
                {% endif %}
              </button>
            {% endif %}

            {% comment %} Results Count {% endcomment %}
            <p class="collection-toolbar__count">
              {{ collection.products_count }} {% if collection.products_count == 1 %}Produkt{% else %}Produkte{% endif %}
            </p>
          </div>

          <div class="collection-toolbar__right">
            {% comment %} Sort {% endcomment %}
            {% if section.settings.enable_sorting %}
              <div class="collection-toolbar__sort">
                <label for="sort-select" class="sr-only">{{ 'collections.sorting.title' | t }}</label>
                <select
                  id="sort-select"
                  class="collection-toolbar__sort-select"
                  onchange="window.location.href = this.value"
                >
                  {% for option in collection.sort_options %}
                    <option value="{{ option.url }}" {% if option.value == collection.sort_by %}selected{% endif %}>
                      {{ option.name }}
                    </option>
                  {% endfor %}
                </select>
                <span class="collection-toolbar__sort-icon">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </div>
            {% endif %}
          </div>
        </div>

        {% comment %} Active Filters {% endcomment %}
        {% if collection.filters.size > 0 %}
          {%- assign has_active_filters = false -%}
          {%- for filter in collection.filters -%}
            {%- if filter.active_values.size > 0 -%}
              {%- assign has_active_filters = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}

          {% if has_active_filters %}
            <div class="collection-active-filters">
              {%- for filter in collection.filters -%}
                {%- for value in filter.active_values -%}
                  <a href="{{ value.url_to_remove }}" class="collection-active-filters__tag">
                    <span>{{ filter.label }}: {{ value.label }}</span>
                    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                      <path d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                  </a>
                {%- endfor -%}
              {%- endfor -%}
              <a href="{{ collection.url }}" class="collection-active-filters__clear">
                {{ 'collections.filtering.clear_all' | t | default: 'Alle entfernen' }}
              </a>
            </div>
          {% endif %}
        {% endif %}

        {% comment %} Products Grid {% endcomment %}
        {% paginate collection.products by products_per_page %}
          {% if collection.products.size > 0 %}
            <div class="collection-grid collection-grid--{{ card_size }}" data-columns="{{ columns }}" style="--card-gap: {{ card_gap }}px;">
              {% for product in collection.products %}
                {% render 'product-card', product: product %}
              {% endfor %}
            </div>

            {% comment %} Pagination {% endcomment %}
            {% if paginate.pages > 1 %}
              <nav class="collection-pagination" aria-label="{{ 'general.pagination.label' | t }}">
                {% if paginate.previous %}
                  <a href="{{ paginate.previous.url }}" class="collection-pagination__btn collection-pagination__btn--prev">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                      <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="hidden sm:inline">{{ 'general.pagination.previous' | t | default: 'Zurueck' }}</span>
                  </a>
                {% endif %}

                <div class="collection-pagination__pages">
                  {% for part in paginate.parts %}
                    {% if part.is_link %}
                      <a href="{{ part.url }}" class="collection-pagination__page">
                        {{ part.title }}
                      </a>
                    {% else %}
                      {% if part.title == paginate.current_page %}
                        <span class="collection-pagination__page is-current">
                          {{ part.title }}
                        </span>
                      {% else %}
                        <span class="collection-pagination__ellipsis">
                          {{ part.title }}
                        </span>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>

                {% if paginate.next %}
                  <a href="{{ paginate.next.url }}" class="collection-pagination__btn collection-pagination__btn--next">
                    <span class="hidden sm:inline">{{ 'general.pagination.next' | t | default: 'Weiter' }}</span>
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                      <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </a>
                {% endif %}
              </nav>
            {% endif %}
          {% else %}
            <div class="collection-empty">
              <div class="collection-empty__icon">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                  <path d="M24 44C35.0457 44 44 35.0457 44 24C44 12.9543 35.0457 4 24 4C12.9543 4 4 12.9543 4 24C4 35.0457 12.9543 44 24 44Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M17 17L31 31M31 17L17 31" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <h2 class="collection-empty__title">{{ 'collections.general.no_matches' | t | default: 'Keine Produkte gefunden' }}</h2>
              <p class="collection-empty__text">{{ 'collections.general.no_matches_text' | t | default: 'Versuche es mit anderen Filteroptionen.' }}</p>
              {% if has_active_filters %}
                <a href="{{ collection.url }}" class="collection-empty__btn">
                  {{ 'collections.filtering.clear_all' | t | default: 'Filter zuruecksetzen' }}
                </a>
              {% endif %}
            </div>
          {% endif %}
        {% endpaginate %}

      </div>
    </div>
  </div>

  {% comment %} ========== FILTER DRAWER ========== {% endcomment %}
  {% if section.settings.enable_filtering %}
    <div
      class="filter-drawer"
      :class="{ 'is-open': filterOpen }"
      x-cloak
    >
      <div
        class="filter-drawer__backdrop"
        @click="filterOpen = false"
        x-show="filterOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
      ></div>
      <div
        class="filter-drawer__panel"
        x-show="filterOpen"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="translate-x-full"
      >
        <div class="filter-drawer__header">
          <h2 class="filter-drawer__title">{{ 'collections.filtering.filter' | t | default: 'Filter' }}</h2>
          <button type="button" class="filter-drawer__close" @click="filterOpen = false" aria-label="Schliessen">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
        <div class="filter-drawer__content">
          <form id="CollectionFiltersFormDrawer" action="{{ collection.url }}" method="get">
            {% render 'collection-filters', collection: collection %}
          </form>
        </div>
        <div class="filter-drawer__footer">
          <a href="{{ collection.url }}" class="filter-drawer__clear">
            {{ 'collections.filtering.clear_all' | t | default: 'Alle entfernen' }}
          </a>
          <button type="button" class="filter-drawer__apply" @click="filterOpen = false">
            {{ 'collections.filtering.apply' | t | default: 'Anwenden' }}
          </button>
        </div>
      </div>
    </div>
  {% endif %}
</section>

<style>
  /* Section Wrapper */
  .main-collection {
    padding: 2rem 0 4rem;
  }

  @media (min-width: 1024px) {
    .main-collection {
      padding: 3rem 0 5rem;
    }
  }

  /* Layout */
  .main-collection__layout {
    display: grid;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .main-collection__layout {
      grid-template-columns: {% if section.settings.enable_filtering and filter_type == 'sidebar' %}260px 1fr{% else %}1fr{% endif %};
      gap: 3rem;
    }
  }

  /* Sidebar */
  .main-collection__sidebar {
    position: sticky;
    top: calc(var(--header-height, 80px) + 1.5rem);
    align-self: start;
  }

  .main-collection__sidebar-inner {
    max-height: calc(100vh - var(--header-height, 80px) - 3rem);
    overflow-y: auto;
    padding-right: 1rem;
  }

  /* Toolbar */
  .collection-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .collection-toolbar__left,
  .collection-toolbar__right {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .collection-toolbar__filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .collection-toolbar__filter-btn:hover {
    border-color: var(--color-primary);
    background-color: var(--color-background-alt);
  }

  .collection-toolbar__filter-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 1.25rem;
    height: 1.25rem;
    padding: 0 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
    color: #ffffff;
    background-color: var(--color-primary);
    border-radius: 9999px;
  }

  .collection-toolbar__count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    margin: 0;
  }

  .collection-toolbar__sort {
    position: relative;
  }

  .collection-toolbar__sort-select {
    appearance: none;
    padding: 0.625rem 2.5rem 0.625rem 1rem;
    font-size: 0.875rem;
    color: var(--color-text);
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }

  .collection-toolbar__sort-select:hover,
  .collection-toolbar__sort-select:focus {
    border-color: var(--color-primary);
    outline: none;
  }

  .collection-toolbar__sort-icon {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--color-text-muted);
  }

  /* Active Filters */
  .collection-active-filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .collection-active-filters__tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    color: var(--color-text);
    background-color: var(--color-background-alt);
    border-radius: 9999px;
    transition: background-color 0.2s ease;
  }

  .collection-active-filters__tag:hover {
    background-color: var(--color-border);
  }

  .collection-active-filters__clear {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-primary);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Product Grid */
  .collection-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--card-gap, 24px);
  }

  /* Card Size Variants */
  .collection-grid--small .product-card {
    font-size: 0.9em;
  }

  .collection-grid--large .product-card {
    font-size: 1.05em;
  }

  .collection-grid--extra_large .product-card {
    font-size: 1.1em;
  }

  .collection-grid--xxl .product-card {
    font-size: 1.15em;
  }

  @media (min-width: 768px) {
    .collection-grid[data-columns="3"] {
      grid-template-columns: repeat(3, 1fr);
    }
    .collection-grid[data-columns="4"],
    .collection-grid[data-columns="5"] {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .collection-grid[data-columns="3"] {
      grid-template-columns: repeat(3, 1fr);
    }
    .collection-grid[data-columns="4"] {
      grid-template-columns: repeat(4, 1fr);
    }
    .collection-grid[data-columns="5"] {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  /* Pagination */
  .collection-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .collection-pagination__btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text);
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    transition: border-color 0.2s ease, background-color 0.2s ease;
  }

  .collection-pagination__btn:hover {
    border-color: var(--color-primary);
    background-color: var(--color-background-alt);
  }

  .collection-pagination__pages {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .collection-pagination__page {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 2.5rem;
    font-size: 0.875rem;
    color: var(--color-text);
    border-radius: 0.5rem;
    transition: background-color 0.2s ease;
  }

  .collection-pagination__page:hover {
    background-color: var(--color-background-alt);
  }

  .collection-pagination__page.is-current {
    font-weight: 600;
    color: #ffffff;
    background-color: var(--color-primary);
  }

  .collection-pagination__ellipsis {
    padding: 0 0.25rem;
    color: var(--color-text-muted);
  }

  /* Empty State */
  .collection-empty {
    text-align: center;
    padding: 4rem 2rem;
  }

  .collection-empty__icon {
    color: var(--color-border);
    margin-bottom: 1.5rem;
  }

  .collection-empty__title {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0 0 0.5rem;
  }

  .collection-empty__text {
    color: var(--color-text-muted);
    margin: 0 0 1.5rem;
  }

  .collection-empty__btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #ffffff;
    background-color: var(--color-primary);
    border-radius: 0.5rem;
    transition: background-color 0.2s ease;
  }

  .collection-empty__btn:hover {
    background-color: var(--color-text);
  }

  /* Filter Drawer */
  .filter-drawer {
    position: fixed;
    inset: 0;
    z-index: 100;
    pointer-events: none;
  }

  .filter-drawer.is-open {
    pointer-events: auto;
  }

  .filter-drawer__backdrop {
    position: absolute;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .filter-drawer__panel {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    max-width: 380px;
    display: flex;
    flex-direction: column;
    background-color: var(--color-background);
    box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
  }

  .filter-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .filter-drawer__title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }

  .filter-drawer__close {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    color: var(--color-text-muted);
    border-radius: 0.5rem;
    transition: color 0.2s ease, background-color 0.2s ease;
  }

  .filter-drawer__close:hover {
    color: var(--color-text);
    background-color: var(--color-background-alt);
  }

  .filter-drawer__content {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
  }

  .filter-drawer__footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--color-border);
  }

  .filter-drawer__clear {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .filter-drawer__apply {
    flex: 1;
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: #ffffff;
    background-color: var(--color-primary);
    border-radius: 0.5rem;
    transition: background-color 0.2s ease;
  }

  .filter-drawer__apply:hover {
    background-color: var(--color-text);
  }
</style>

{% schema %}
{
  "name": "Produktliste",
  "class": "section-main-collection",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 36,
      "step": 4,
      "default": 12,
      "label": "Produkte pro Seite"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 3,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Spalten (Desktop)"
    },
    {
      "type": "select",
      "id": "card_size",
      "label": "Produktkarten-Groesse",
      "options": [
        {
          "value": "small",
          "label": "Klein"
        },
        {
          "value": "medium",
          "label": "Mittel"
        },
        {
          "value": "large",
          "label": "Gross"
        },
        {
          "value": "extra_large",
          "label": "Sehr gross"
        },
        {
          "value": "xxl",
          "label": "XXL"
        }
      ],
      "default": "medium",
      "info": "Beeinflusst die Schriftgroesse der Produktkarten"
    },
    {
      "type": "range",
      "id": "card_gap",
      "min": 8,
      "max": 64,
      "step": 4,
      "default": 24,
      "unit": "px",
      "label": "Abstand zwischen Karten"
    },
    {
      "type": "header",
      "content": "Filter & Sortierung"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "default": true,
      "label": "Filter aktivieren"
    },
    {
      "type": "select",
      "id": "filter_type",
      "label": "Filter Darstellung",
      "options": [
        { "value": "drawer", "label": "Drawer (Seitenpanel)" },
        { "value": "sidebar", "label": "Sidebar (Desktop)" }
      ],
      "default": "drawer"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "default": true,
      "label": "Sortierung aktivieren"
    }
  ]
}
{% endschema %}
