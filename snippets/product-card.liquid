{% comment %}
  Product Card Snippet - Enhanced with premium hover effects
  Usage: {% render 'product-card', product: product %}
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign featured_image = product.featured_image
  assign is_sold_out = false
  if current_variant.available == false
    assign is_sold_out = true
  endif

  assign card_style = settings.product_card_style | default: 'rounded'
  assign image_ratio = settings.product_card_image_ratio | default: 'portrait'
  assign show_secondary = settings.product_card_show_secondary_image
-%}

<article class="product-card product-card--{{ card_style }} product-card--ratio-{{ image_ratio }}" data-product-id="{{ product.id }}">

  {% comment %} Product Image Container {% endcomment %}
  <div class="product-card__media">
    <a href="{{ product.url }}" class="product-card__link" aria-label="{{ product.title | escape }}">

      {% comment %} Badges {% endcomment %}
      <div class="product-card__badges">
        {% if product.compare_at_price > product.price %}
          {%- assign discount_percent = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round -%}
          <span class="product-card__badge product-card__badge--sale">
            -{{ discount_percent }}%
          </span>
        {% endif %}
        {% if is_sold_out %}
          <span class="product-card__badge product-card__badge--soldout">
            {{ 'products.product.sold_out' | t }}
          </span>
        {% endif %}
      </div>

      {% comment %} Product Images {% endcomment %}
      {% if featured_image != blank %}
        <div class="product-card__image-wrapper">
          <img
            src="{{ featured_image | image_url: width: 600 }}"
            srcset="{{ featured_image | image_url: width: 300 }} 300w,
                    {{ featured_image | image_url: width: 450 }} 450w,
                    {{ featured_image | image_url: width: 600 }} 600w,
                    {{ featured_image | image_url: width: 800 }} 800w"
            sizes="(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 25vw"
            alt="{{ featured_image.alt | default: product.title | escape }}"
            width="{{ featured_image.width }}"
            height="{{ featured_image.height }}"
            class="product-card__image product-card__image--primary"
            loading="lazy"
          >

          {% comment %} Secondary Image on Hover {% endcomment %}
          {% if product.images.size > 1 and show_secondary %}
            <img
              src="{{ product.images[1] | image_url: width: 600 }}"
              srcset="{{ product.images[1] | image_url: width: 300 }} 300w,
                      {{ product.images[1] | image_url: width: 450 }} 450w,
                      {{ product.images[1] | image_url: width: 600 }} 600w"
              alt="{{ product.images[1].alt | default: product.title | escape }}"
              width="{{ product.images[1].width }}"
              height="{{ product.images[1].height }}"
              class="product-card__image product-card__image--secondary"
              loading="lazy"
            >
          {% endif %}
        </div>
      {% else %}
        <div class="product-card__placeholder">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
        </div>
      {% endif %}

    </a>

    {% comment %} Quick Action Buttons {% endcomment %}
    <div class="product-card__actions">
      {% comment %} Quick View {% endcomment %}
      <button
        type="button"
        class="product-card__action"
        aria-label="{{ 'products.product.quick_view' | t }}"
        @click.prevent="$dispatch('quick-view', { handle: '{{ product.handle }}' })"
      >
        <svg class="product-card__action-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      </button>

      {% comment %} Wishlist {% endcomment %}
      <button
        type="button"
        class="product-card__action product-card__action--wishlist"
        :class="{ 'is-wishlisted': $store.wishlist && $store.wishlist.has({{ product.id }}) }"
        aria-label="{{ 'products.product.add_to_wishlist' | t }}"
        @click.prevent="$store.wishlist.toggle({{ product.id }}, '{{ product.handle }}', '{{ product.title | escape }}', '{{ product.featured_image | image_url: width: 200 }}', '{{ product.price | money }}', '{{ product.url }}')"
      >
        <svg class="product-card__action-icon product-card__action-icon--outline" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
        <svg class="product-card__action-icon product-card__action-icon--filled" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>
    </div>

    {% comment %} Add to Cart Button (appears on hover) {% endcomment %}
    {% unless is_sold_out %}
      <form method="post" action="/cart/add" class="product-card__add-form">
        <input type="hidden" name="id" value="{{ current_variant.id }}">
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="product-card__add-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 6h15l-1.5 9h-12z"/>
            <circle cx="9" cy="20" r="1"/>
            <circle cx="18" cy="20" r="1"/>
            <path d="M6 6L5 3H2"/>
          </svg>
          <span>{{ 'products.product.add_to_cart' | t }}</span>
        </button>
      </form>
    {% endunless %}
  </div>

  {% comment %} Product Content {% endcomment %}
  <div class="product-card__content">

    {% comment %} Vendor/Brand {% endcomment %}
    {% if product.vendor != blank %}
      <span class="product-card__vendor">
        {{ product.vendor }}
      </span>
    {% endif %}

    {% comment %} Product Title {% endcomment %}
    <h3 class="product-card__title">
      <a href="{{ product.url }}">
        {{ product.title }}
      </a>
    </h3>

    {% comment %} Product Price {% endcomment %}
    <div class="product-card__price">
      {% if product.compare_at_price > product.price %}
        <span class="product-card__price-sale">{{ product.price | money }}{% unless settings.show_tax_included %}<sup class="product-card__asterisk">*</sup>{% endunless %}</span>
        <span class="product-card__price-compare">{{ product.compare_at_price | money }}</span>
      {% else %}
        <span class="product-card__price-regular">{{ product.price | money }}{% unless settings.show_tax_included %}<sup class="product-card__asterisk">*</sup>{% endunless %}</span>
      {% endif %}
    </div>

    {% comment %} Color/Variant Swatches with Image Preview {% endcomment %}
    {% if product.options_with_values.size > 0 %}
      {% for option in product.options_with_values %}
        {%- liquid
          assign is_color_option = false
          assign option_name_lower = option.name | downcase
          assign option_index = forloop.index0
          if option_name_lower == 'color' or option_name_lower == 'farbe' or option_name_lower == 'colour'
            assign is_color_option = true
          endif
        -%}
        {% if is_color_option %}
          <div class="product-card__swatches" data-product-id="{{ product.id }}">
            {% for value in option.values limit: 5 %}
              {%- liquid
                assign color_value = value | downcase
                assign color_map = ''
                assign variant_image_url = ''

                comment
                  Find the variant with this color value and get its image
                endcomment
                for variant in product.variants
                  assign variant_option_value = variant.options[option_index] | downcase
                  if variant_option_value == color_value and variant.featured_media != nil
                    assign variant_image_url = variant.featured_media | image_url: width: 600
                    break
                  endif
                endfor

                case color_value
                  when 'schwarz', 'black'
                    assign color_map = '#000000'
                  when 'weiss', 'weiß', 'white'
                    assign color_map = '#FFFFFF'
                  when 'rot', 'red'
                    assign color_map = '#DC2626'
                  when 'blau', 'blue'
                    assign color_map = '#2563EB'
                  when 'gruen', 'grün', 'green'
                    assign color_map = '#16A34A'
                  when 'gelb', 'yellow'
                    assign color_map = '#EAB308'
                  when 'orange'
                    assign color_map = '#EA580C'
                  when 'rosa', 'pink'
                    assign color_map = '#EC4899'
                  when 'lila', 'purple', 'violett'
                    assign color_map = '#9333EA'
                  when 'braun', 'brown'
                    assign color_map = '#78350f'
                  when 'grau', 'grey', 'gray'
                    assign color_map = '#6B7280'
                  when 'beige', 'creme', 'cream'
                    assign color_map = '#d4b896'
                  when 'gold'
                    assign color_map = '#b8860b'
                  when 'silber', 'silver'
                    assign color_map = '#C0C0C0'
                  when 'messing', 'brass'
                    assign color_map = '#b5a642'
                  when 'kupfer', 'copper'
                    assign color_map = '#b87333'
                  when 'natur', 'natural', 'holz', 'wood'
                    assign color_map = '#deb887'
                  when 'olive', 'oliv', 'olivgruen', 'olivgrün'
                    assign color_map = '#556B2F'
                  when 'terrakotta', 'terracotta', 'terracota'
                    assign color_map = '#C04000'
                  when 'sand'
                    assign color_map = '#CCBB99'
                  else
                    assign color_map = value | handleize
                endcase
              -%}
              <span
                class="product-card__swatch{% if color_value == 'weiss' or color_value == 'weiß' or color_value == 'white' %} product-card__swatch--bordered{% endif %}"
                style="background-color: {{ color_map }};"
                title="{{ value }}"
                {% if variant_image_url != blank %}
                  data-variant-image="{{ variant_image_url }}"
                {% endif %}
                data-original-image="{{ product.featured_image | image_url: width: 600 }}"
              ></span>
            {% endfor %}
            {% if option.values.size > 5 %}
              <span class="product-card__swatch-more">+{{ option.values.size | minus: 5 }}</span>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

  </div>
</article>

<style>
  /* Product Card Base */
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  /* Media Container */
  .product-card__media {
    position: relative;
    overflow: hidden;
    border-radius: 0;
    background: var(--color-background-alt, #f8f8f6);
  }

  /* Card Style Variants */
  .product-card--rounded .product-card__media {
    border-radius: 0.75rem;
  }

  .product-card--slightly_rounded .product-card__media {
    border-radius: 0.375rem;
  }

  .product-card--square .product-card__media {
    border-radius: 0;
  }

  .product-card__link {
    display: block;
    aspect-ratio: 3/4;
  }

  /* Image Ratio Variants */
  .product-card--ratio-portrait .product-card__link {
    aspect-ratio: 3/4;
  }

  .product-card--ratio-square .product-card__link {
    aspect-ratio: 1/1;
  }

  .product-card--ratio-landscape .product-card__link {
    aspect-ratio: 4/3;
  }

  .product-card__image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }

  /* Images */
  .product-card__image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.4s ease, transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .product-card__image--primary {
    opacity: 1;
  }

  .product-card__image--secondary {
    opacity: 0;
  }

  @media (hover: hover) {
    .product-card__media:hover .product-card__image--primary {
      opacity: 0;
      transform: scale(1.02);
    }

    .product-card__media:hover .product-card__image--secondary {
      opacity: 1;
      transform: scale(1.02);
    }

    /* If no secondary image, just zoom primary */
    .product-card__image--primary:only-child {
      opacity: 1 !important;
    }

    .product-card__media:hover .product-card__image--primary:only-child {
      transform: scale(1.05);
    }
  }

  /* Placeholder */
  .product-card__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    color: var(--color-border);
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .product-card__badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.625rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    border-radius: 0.25rem;
  }

  .product-card__badge--sale {
    background: var(--color-accent);
    color: white;
  }

  .product-card__badge--soldout {
    background: var(--color-text);
    color: white;
  }

  /* Quick Action Buttons */
  .product-card__actions {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 10;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    opacity: 0;
    transform: translateX(0.5rem);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  @media (hover: hover) {
    .product-card__media:hover .product-card__actions {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .product-card__action {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: white;
    border: none;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
  }

  .product-card__action:hover {
    background: var(--color-primary);
    color: white;
    transform: scale(1.1);
  }

  .product-card__action-icon {
    transition: inherit;
  }

  /* Wishlist Button States */
  .product-card__action--wishlist .product-card__action-icon--filled {
    display: none;
    color: #ef4444;
  }

  .product-card__action--wishlist.is-wishlisted {
    background: #fef2f2;
    color: #ef4444;
  }

  .product-card__action--wishlist.is-wishlisted .product-card__action-icon--outline {
    display: none;
  }

  .product-card__action--wishlist.is-wishlisted .product-card__action-icon--filled {
    display: block;
  }

  .product-card__action--wishlist.is-wishlisted:hover {
    background: #ef4444;
    color: white;
  }

  .product-card__action--wishlist.is-wishlisted:hover .product-card__action-icon--filled {
    color: white;
  }

  /* Add to Cart Button */
  .product-card__add-form {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    padding: 0.75rem;
    opacity: 0;
    transform: translateY(100%);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  @media (hover: hover) {
    .product-card__media:hover .product-card__add-form {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .product-card__add-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--color-text);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 0.8125rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.15s ease;
  }

  .product-card__add-btn:hover {
    background: var(--color-primary);
  }

  .product-card__add-btn:active {
    transform: scale(0.98);
  }

  /* Content */
  .product-card__content {
    padding: 1rem 0.25rem 0;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .product-card__vendor {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
    margin-bottom: 0.25rem;
  }

  .product-card__title {
    font-size: 0.9375rem;
    font-weight: 500;
    line-height: 1.4;
    margin: 0 0 0.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-card__title a {
    color: var(--color-text);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .product-card__title a:hover {
    color: var(--color-primary);
  }

  /* Price */
  .product-card__price {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: auto;
  }

  .product-card__price-regular,
  .product-card__price-sale {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .product-card__price-sale {
    color: var(--color-accent);
  }

  .product-card__price-compare {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    text-decoration: line-through;
  }

  .product-card__asterisk {
    font-size: 0.65em;
    color: var(--color-text-muted);
    margin-left: 1px;
    vertical-align: super;
    font-weight: 400;
  }

  /* Color Swatches */
  .product-card__swatches {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-top: 0.625rem;
    flex-wrap: wrap;
  }

  .product-card__swatch {
    width: 1rem;
    height: 1rem;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .product-card__swatch--bordered {
    box-shadow: inset 0 0 0 1px var(--color-border);
  }

  .product-card__swatch:hover {
    transform: scale(1.2);
    box-shadow: 0 0 0 2px var(--color-background), 0 0 0 3px var(--color-primary);
  }

  .product-card__swatch-more {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    padding-left: 0.25rem;
  }

  /* Mobile Touch Optimizations */
  @media (hover: none) {
    .product-card__actions {
      opacity: 1;
      transform: translateX(0);
    }

    .product-card__add-form {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile: Always show add-to-cart button */
  @media (max-width: 1023px) {
    .product-card__add-form {
      position: relative;
      opacity: 1;
      transform: none;
      padding: 0.5rem 0 0;
      bottom: auto;
      left: auto;
      right: auto;
    }

    .product-card__add-btn {
      padding: 0.625rem 0.875rem;
      font-size: 0.75rem;
      border-radius: 0.375rem;
    }

    .product-card__actions {
      opacity: 1;
      transform: translateX(0);
    }

    /* Hide quick view on mobile, keep wishlist */
    .product-card__action:not(.product-card__action--wishlist) {
      display: none;
    }
  }

  /* Skeleton Loading State (optional) */
  .product-card--loading .product-card__media {
    background: linear-gradient(90deg, var(--color-background-alt) 25%, var(--color-border) 50%, var(--color-background-alt) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* Swatch hover active state */
  .product-card__swatch--active {
    transform: scale(1.2);
    box-shadow: 0 0 0 2px var(--color-background), 0 0 0 3px var(--color-primary);
  }
</style>

<script>
  {% comment %} Product Card Swatch Image Preview {% endcomment %}
  (function() {
    function initSwatchImagePreview() {
      const swatches = document.querySelectorAll('.product-card__swatch[data-variant-image]');

      swatches.forEach(swatch => {
        const productCard = swatch.closest('.product-card');
        if (!productCard) return;

        const primaryImage = productCard.querySelector('.product-card__image--primary');
        if (!primaryImage) return;

        const originalSrc = swatch.dataset.originalImage;
        const variantSrc = swatch.dataset.variantImage;

        // On mouse enter - show variant image
        swatch.addEventListener('mouseenter', function() {
          if (variantSrc) {
            primaryImage.src = variantSrc;
            // Also update srcset for responsive images
            primaryImage.srcset = variantSrc + ' 600w';

            // Mark this swatch as active
            const allSwatches = swatch.closest('.product-card__swatches').querySelectorAll('.product-card__swatch');
            allSwatches.forEach(s => s.classList.remove('product-card__swatch--active'));
            swatch.classList.add('product-card__swatch--active');
          }
        });

        // On mouse leave from swatches container - restore original image
        const swatchesContainer = swatch.closest('.product-card__swatches');
        if (swatchesContainer && !swatchesContainer.hasAttribute('data-hover-init')) {
          swatchesContainer.setAttribute('data-hover-init', 'true');

          swatchesContainer.addEventListener('mouseleave', function() {
            if (originalSrc) {
              primaryImage.src = originalSrc;
              primaryImage.srcset = originalSrc + ' 600w';
            }
            // Remove active state from all swatches
            const allSwatches = swatchesContainer.querySelectorAll('.product-card__swatch');
            allSwatches.forEach(s => s.classList.remove('product-card__swatch--active'));
          });
        }
      });
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSwatchImagePreview);
    } else {
      initSwatchImagePreview();
    }

    // Re-initialize when new content is loaded (for infinite scroll, filters, etc.)
    document.addEventListener('shopify:section:load', initSwatchImagePreview);

    // Also listen for custom events from AJAX filtering
    document.addEventListener('collection:updated', initSwatchImagePreview);
  })();
</script>
