{% comment %}
  Upsell Checkbox Snippet
  Zeigt Checkboxen fuer passende Zusatzprodukte an, basierend auf dem Metafeld product.metafields.custom.related_accessory (Liste)

  Verwendung: {% render 'upsell-checkbox', product: product %}
{% endcomment %}

{%- liquid
  assign related_products = product.metafields.custom.related_accessory.value
  assign has_available_products = false
  for related_product in related_products
    if related_product.available
      assign has_available_products = true
      break
    endif
  endfor
-%}

{% if related_products != blank and related_products.size > 0 and has_available_products %}
  <div class="upsell-section" data-upsell-container>
    <div class="upsell-section__header">
      <span class="upsell-section__title">Dazu passend:</span>
    </div>
    <div class="upsell-section__items">
      {% for related_product in related_products %}
        {% if related_product.available %}
          {%- assign upsell_variant = related_product.first_available_variant -%}

          <div class="upsell-item">
            <label class="upsell-item__label">
              <input
                type="checkbox"
                class="upsell-item__input"
                data-upsell-checkbox
                data-upsell-variant-id="{{ upsell_variant.id }}"
                data-upsell-price="{{ upsell_variant.price }}"
              >
              <span class="upsell-item__checkmark">
                <svg width="12" height="10" viewBox="0 0 12 10" fill="none">
                  <path d="M1 5L4 8L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="upsell-item__content">
                {% if related_product.featured_image %}
                  <span class="upsell-item__image">
                    <img
                      src="{{ related_product.featured_image | image_url: width: 100 }}"
                      alt="{{ related_product.title | escape }}"
                      width="50"
                      height="50"
                      loading="lazy"
                    >
                  </span>
                {% endif %}
                <span class="upsell-item__info">
                  <span class="upsell-item__name">{{ related_product.title }}</span>
                  <span class="upsell-item__price">+ {{ upsell_variant.price | money }}{% unless settings.show_tax_included %}<sup class="upsell-item__asterisk">*</sup>{% endunless %}</span>
                </span>
              </span>
            </label>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <style>
    .upsell-section {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--color-background-alt, #f9f9f9);
      border: 1px solid var(--color-border, #e5e5e5);
      border-radius: 0.5rem;
    }

    .upsell-section__header {
      margin-bottom: 0.75rem;
    }

    .upsell-section__title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--color-text, #1a1a1a);
    }

    .upsell-section__items {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .upsell-item {
      padding: 0.75rem;
      background: var(--color-background, #fff);
      border: 1px solid var(--color-border, #e5e5e5);
      border-radius: 0.375rem;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .upsell-item:has(.upsell-item__input:checked) {
      border-color: var(--color-primary, #d4a574);
      background: rgba(212, 165, 116, 0.05);
    }

    .upsell-item__label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      user-select: none;
    }

    .upsell-item__input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .upsell-item__checkmark {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      background: var(--color-background, #fff);
      border: 2px solid var(--color-border, #e5e5e5);
      border-radius: 0.25rem;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .upsell-item__checkmark svg {
      opacity: 0;
      color: white;
      transition: opacity 0.2s ease;
    }

    .upsell-item__input:checked + .upsell-item__checkmark {
      background: var(--color-primary, #d4a574);
      border-color: var(--color-primary, #d4a574);
    }

    .upsell-item__input:checked + .upsell-item__checkmark svg {
      opacity: 1;
    }

    .upsell-item__input:focus + .upsell-item__checkmark {
      box-shadow: 0 0 0 2px rgba(212, 165, 116, 0.3);
    }

    .upsell-item__content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }

    .upsell-item__image {
      flex-shrink: 0;
      width: 44px;
      height: 44px;
      border-radius: 0.25rem;
      overflow: hidden;
      background: var(--color-background-alt, #f9f9f9);
    }

    .upsell-item__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .upsell-item__info {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
      flex: 1;
    }

    @media (min-width: 400px) {
      .upsell-item__info {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 0.5rem;
      }
    }

    .upsell-item__name {
      font-size: 0.8125rem;
      font-weight: 500;
      color: var(--color-text, #1a1a1a);
      line-height: 1.3;
    }

    .upsell-item__price {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--color-primary, #d4a574);
      white-space: nowrap;
    }

    .upsell-item__asterisk {
      font-size: 0.65em;
      color: var(--color-text-muted, #666);
      margin-left: 1px;
      vertical-align: super;
      font-weight: 400;
    }
  </style>
{% endif %}
